FROM node:18-alpine AS builder

WORKDIR /app

# Copia apenas os arquivos de dependências primeiro (para melhor cache)
COPY package*.json ./

# Instala dependências com cache otimizado para ARM
RUN npm ci --silent --no-optional --prefer-offline

# Copia o restante do código
COPY . .

# Build com variáveis de otimização
ENV NODE_ENV=production
ENV GENERATE_SOURCEMAP=false
ENv DISABLE_ESLINT_PLUGIN=true

RUN npm run build

# Imagem final mínima
FROM node:18-alpine AS runner

WORKDIR /app

# Instala serve globalmente
RUN npm install -g serve@14.2.1

# Copia apenas os arquivos buildados
COPY --from=builder /app/build ./build

# Expõe a porta
EXPOSE 3000

# Comando para servir os arquivos buildados
CMD ["serve", "-s", "build", "-l", "3000"]